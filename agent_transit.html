<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Israel Transit Agent Dashboard</title>
  <style>
    :root {
      --bg:       #0d1117;
      --surface:  #161b22;
      --border:   #30363d;
      --accent:   #1f6feb;
      --green:    #3fb950;
      --yellow:   #d29922;
      --red:      #f85149;
      --text:     #e6edf3;
      --muted:    #8b949e;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    header h1 { font-size: 1.25rem; font-weight: 700; }
    header h1 span { color: var(--accent); }

    #live-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: .8rem;
      color: var(--muted);
    }
    #live-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--green);
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 1; }
      50%      { opacity: .3; }
    }

    /* â”€â”€ Layout â”€â”€ */
    main { padding: 24px; display: flex; flex-direction: column; gap: 20px; }

    /* â”€â”€ Status cards â”€â”€ */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
    }
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px 18px;
    }
    .card .label { font-size: .75rem; color: var(--muted); margin-bottom: 6px; }
    .card .value { font-size: 1.6rem; font-weight: 700; }
    .card .sub   { font-size: .75rem; color: var(--muted); margin-top: 4px; }
    .card.ok   { border-top: 3px solid var(--green); }
    .card.warn { border-top: 3px solid var(--yellow); }
    .card.err  { border-top: 3px solid var(--red); }

    /* â”€â”€ Chat panel â”€â”€ */
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .panel-header {
      padding: 12px 18px;
      border-bottom: 1px solid var(--border);
      font-size: .85rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .panel-body { padding: 16px 18px; }

    /* Chat */
    #chat-log {
      height: 300px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-bottom: 8px;
    }
    .msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: .88rem;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .msg.user {
      background: var(--accent);
      align-self: flex-start;
      border-radius: 12px 12px 12px 2px;
    }
    .msg.bot {
      background: #21262d;
      border: 1px solid var(--border);
      align-self: flex-end;
      border-radius: 12px 12px 2px 12px;
    }
    .msg.bot.loading { color: var(--muted); font-style: italic; }

    #chat-form {
      display: flex;
      gap: 10px;
      margin-top: 14px;
    }
    #chat-input {
      flex: 1;
      padding: 10px 14px;
      background: #0d1117;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: .9rem;
      outline: none;
    }
    #chat-input:focus { border-color: var(--accent); }
    #chat-input::placeholder { color: var(--muted); }

    button.send-btn {
      padding: 10px 18px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: .9rem;
      font-weight: 600;
      transition: background .2s;
    }
    button.send-btn:hover { background: #388bfd; }
    button.send-btn:disabled { background: var(--border); cursor: default; }

    /* Suggestions */
    .suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .chip {
      padding: 5px 12px;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: .78rem;
      color: var(--muted);
      cursor: pointer;
      transition: all .15s;
    }
    .chip:hover { border-color: var(--accent); color: var(--accent); }

    /* Bus table */
    #bus-table-wrap {
      overflow-x: auto;
      max-height: 320px;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: .82rem;
    }
    th {
      position: sticky;
      top: 0;
      background: var(--surface);
      padding: 8px 12px;
      text-align: right;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
      font-weight: 600;
    }
    td {
      padding: 8px 12px;
      border-bottom: 1px solid #21262d;
    }
    tr:hover td { background: #21262d; }

    /* Service status list */
    .svc-list { display: flex; flex-direction: column; gap: 8px; }
    .svc-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #21262d;
      font-size: .85rem;
    }
    .badge {
      padding: 2px 10px;
      border-radius: 20px;
      font-size: .72rem;
      font-weight: 700;
    }
    .badge.up   { background: #238636; color: #3fb950; }
    .badge.down { background: #3d1f1f; color: #f85149; }
    .badge.chk  { background: #2d2003; color: #d29922; }

    /* Grid 2-col */
    .two-col {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    @media (max-width: 768px) { .two-col { grid-template-columns: 1fr; } }

    /* refresh btn */
    .refresh-btn {
      padding: 4px 12px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--muted);
      cursor: pointer;
      font-size: .75rem;
    }
    .refresh-btn:hover { border-color: var(--accent); color: var(--accent); }
  </style>
</head>
<body>

<header>
  <h1>ğŸšŒ Israel <span>Transit Agent</span></h1>
  <div id="live-badge">
    <div id="live-dot"></div>
    <span id="live-label">××ª×—×‘×¨â€¦</span>
  </div>
</header>

<main>

  <!-- KPI cards -->
  <div class="cards" id="kpi-cards">
    <div class="card" id="card-buses">
      <div class="label">××•×˜×•×‘×•×¡×™× ×¤×¢×™×œ×™×</div>
      <div class="value" id="kpi-buses">â€“</div>
      <div class="sub">×‘×–××Ÿ ×××ª</div>
    </div>
    <div class="card" id="card-stops">
      <div class="label">×ª×—× ×•×ª ×××•×¤×•×ª</div>
      <div class="value" id="kpi-stops">â€“</div>
      <div class="sub">××§×•×¨×‘</div>
    </div>
    <div class="card" id="card-api">
      <div class="label">Bot API</div>
      <div class="value" id="kpi-api" style="font-size:1rem">â€“</div>
      <div class="sub">localhost:5000</div>
    </div>
    <div class="card" id="card-src">
      <div class="label">××§×•×¨ × ×ª×•× ×™×</div>
      <div class="value" id="kpi-src" style="font-size:.9rem">â€“</div>
      <div class="sub">GTFS-RT / SIRI</div>
    </div>
  </div>

  <!-- Chat + Services -->
  <div class="two-col">

    <!-- Agent Chat -->
    <div class="panel">
      <div class="panel-header">
        ğŸ¤– Transit Agent Chat
        <span style="font-size:.75rem;color:var(--muted)">×©××œ ×¢×œ × ×ª×•× ×™ ×ª×—×‘×•×¨×”</span>
      </div>
      <div class="panel-body">
        <div class="suggestions">
          <span class="chip" onclick="ask('×›××” ××•×˜×•×‘×•×¡×™× ×¤×¢×™×œ×™×?')">×›××” ××•×˜×•×‘×•×¡×™× ×¤×¢×™×œ×™×?</span>
          <span class="chip" onclick="ask('×§×• 1')">×§×• 1</span>
          <span class="chip" onclick="ask('×§×• 480')">×§×• 480</span>
          <span class="chip" onclick="ask('×ª×—× ×”: ×ª×œ ××‘×™×‘')">×ª×œ ××‘×™×‘</span>
          <span class="chip" onclick="ask('×ª×—× ×”: ×¨×—×•×‘ ×“×™×–× ×’×•×£')">×“×™×–× ×’×•×£</span>
          <span class="chip" onclick="ask('××”×™×¨×•×ª ×××•×¦×¢×ª')">××”×™×¨×•×ª</span>
          <span class="chip" onclick="ask('××” ××¦×‘ ×”×©×™×¨×•×ª×™×?')">××¦×‘ ×©×™×¨×•×ª×™×</span>
          <span class="chip" onclick="ask('×”×¦×’ ×›×œ ×”×§×•×•×™×')">×›×œ ×”×§×•×•×™×</span>
        </div>
        <div id="chat-log"></div>
        <form id="chat-form" onsubmit="handleChat(event)">
          <input id="chat-input" type="text" placeholder="×§×• 1 / ×ª×—× ×”: ×“×™×–× ×’×•×£ / ×›××” ××•×˜×•×‘×•×¡×™×?" autocomplete="off" />
          <button class="send-btn" type="submit" id="send-btn">×©×œ×—</button>
        </form>
        <div id="filter-bar" style="display:none;margin-top:10px;padding:7px 12px;background:#21262d;border-radius:8px;font-size:.8rem;align-items:center;justify-content:space-between">
          <span id="filter-label" style="color:var(--yellow)"></span>
          <button onclick="clearFilter()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:.85rem">âœ• × ×§×”</button>
        </div>
      </div>
    </div>

    <!-- Service status -->
    <div class="panel">
      <div class="panel-header">
        ğŸ”Œ ××¦×‘ ×©×™×¨×•×ª×™×
        <button class="refresh-btn" onclick="checkServices()">â†» ×¨×¢× ×Ÿ</button>
      </div>
      <div class="panel-body">
        <div class="svc-list" id="svc-list">
          <div style="color:var(--muted);font-size:.85rem">×˜×•×¢×Ÿâ€¦</div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bus table -->
  <div class="panel">
    <div class="panel-header">
      ğŸ“ ××™×§×•××™ ××•×˜×•×‘×•×¡×™× ×‘×–××Ÿ ×××ª
      <button class="refresh-btn" onclick="loadBuses()">â†» ×¨×¢× ×Ÿ</button>
    </div>
    <div class="panel-body">
      <div id="bus-table-wrap">
        <table id="bus-table">
          <thead>
            <tr>
              <th>Vehicle ID</th>
              <th>×§×• (Route)</th>
              <th>Trip ID</th>
              <th>×§×• ×¨×•×—×‘</th>
              <th>×§×• ××•×¨×š</th>
              <th>××”×™×¨×•×ª (km/h)</th>
              <th>×›×™×•×•×Ÿ</th>
              <th>×ª×—× ×” ×§×¨×•×‘×”</th>
              <th>××¨×—×§ (×')</th>
              <th>×¢×“×›×•×Ÿ</th>
            </tr>
          </thead>
          <tbody id="bus-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

</main>

<script>
const BOT = 'http://localhost:5000';

// â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function apiFetch(path) {
  const r = await fetch(BOT + path);
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

function setCard(id, cls, val) {
  const el = document.getElementById(id);
  if (el) { el.textContent = val; }
  const card = el?.closest('.card');
  if (card && cls) { card.className = 'card ' + cls; }
}

// â”€â”€ KPI / health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadHealth() {
  try {
    const h = await apiFetch('/health');
    document.getElementById('kpi-api').textContent  = 'âœ… Online';
    document.getElementById('card-api').className   = 'card ok';
    document.getElementById('live-label').textContent = '××—×•×‘×¨';
    document.getElementById('live-dot').style.background = 'var(--green)';
  } catch {
    document.getElementById('kpi-api').textContent  = 'âŒ Offline';
    document.getElementById('card-api').className   = 'card err';
    document.getElementById('live-label').textContent = '×× ×•×ª×§';
    document.getElementById('live-dot').style.background = 'var(--red)';
  }
}

// â”€â”€ Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SERVICES = [
  { label: 'Bot API',          url: 'http://localhost:5000/health' },
  { label: 'Airflow',          url: 'http://localhost:8081/health' },
  { label: 'Kafka UI',         url: 'http://localhost:8080' },
  { label: 'MinIO',            url: 'http://localhost:9001' },
  { label: 'Elasticsearch',    url: 'http://localhost:9200' },
  { label: 'Kibana',           url: 'http://localhost:5601' },
];

async function checkServices() {
  const list = document.getElementById('svc-list');
  list.innerHTML = '<div style="color:var(--muted);font-size:.85rem">×‘×•×“×§â€¦</div>';
  const rows = await Promise.all(
    SERVICES.map(async s => {
      let ok = false;
      try { const r = await fetch(s.url, {mode:'no-cors'}); ok = true; }
      catch { ok = false; }
      return `<div class="svc-row">
        <span>${s.label}</span>
        <span class="badge ${ok ? 'up' : 'down'}">${ok ? 'UP' : 'DOWN'}</span>
      </div>`;
    })
  );
  list.innerHTML = rows.join('');
}

// â”€â”€ Bus table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadBuses() {
  const tbody = document.getElementById('bus-tbody');
  tbody.innerHTML = '<tr><td colspan="10" style="color:var(--muted);text-align:center">×˜×•×¢×Ÿâ€¦</td></tr>';
  try {
    const buses = await apiFetch('/buses');
    busCache = buses;  // keep cache in sync
    setCard('kpi-buses', 'ok', buses.length);
    if (!buses.length) {
      tbody.innerHTML = '<tr><td colspan="10" style="color:var(--muted);text-align:center">××™×Ÿ × ×ª×•× ×™×</td></tr>';
      return;
    }
    // detect source from first record
    const src = buses[0].source || 'GTFS-RT';
    document.getElementById('kpi-src').textContent =
      src === 'hasadna-siri' ? 'Hasadna SIRI âœ…' : 'MOT GTFS-RT';

    renderBusRows(buses);
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="10" style="color:var(--red)">×©×’×™××”: ${e.message}</td></tr>`;
  }
}

function renderBusRows(buses) {
  const tbody = document.getElementById('bus-tbody');
  if (!buses.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="color:var(--muted);text-align:center">××™×Ÿ × ×ª×•× ×™×</td></tr>';
    return;
  }
  tbody.innerHTML = buses.slice(0, 100).map(b => {
    const ts   = b.timestamp ? new Date(b.timestamp).toLocaleTimeString('he-IL') : 'â€“';
    const vel  = b.velocity != null ? Math.round(b.velocity) : 'â€“';
    const bear = b.bearing  != null ? b.bearing + 'Â°' : 'â€“';
    const dist = b.distance_to_stop_m != null ? Math.round(b.distance_to_stop_m) : 'â€“';
    return `<tr>
      <td>${b.vehicle_id ?? 'â€“'}</td>
      <td><b>${b.route_id ?? 'â€“'}</b></td>
      <td>${b.trip_id    ?? 'â€“'}</td>
      <td>${b.lat != null ? b.lat.toFixed(5) : 'â€“'}</td>
      <td>${b.lon != null ? b.lon.toFixed(5) : 'â€“'}</td>
      <td>${vel}</td>
      <td>${bear}</td>
      <td>${b.nearest_stop_name ?? 'â€“'}</td>
      <td>${dist}</td>
      <td>${ts}</td>
    </tr>`;
  }).join('');
}

function renderFilteredTable(matches) {
  renderBusRows(matches);
  document.getElementById('bus-table-wrap').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

// â”€â”€ Chat Agent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let busCache = [], stopCache = [];
let activeFilter = null; // { type, value, matches }

function appendMsg(html, role, isHTML = false) {
  const log = document.getElementById('chat-log');
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  if (isHTML) div.innerHTML = html;
  else        div.textContent = html;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
  return div;
}

function setFilter(label, matches) {
  activeFilter = { label, matches };
  const bar = document.getElementById('filter-bar');
  document.getElementById('filter-label').textContent = `ğŸ” ××¡× ×Ÿ: ${label} (${matches.length} ×ª×•×¦××•×ª)`;
  bar.style.display = 'flex';
  renderFilteredTable(matches);
}

function clearFilter() {
  activeFilter = null;
  document.getElementById('filter-bar').style.display = 'none';
  renderBusRows(busCache);
}

async function handleChat(e) {
  e.preventDefault();
  const input = document.getElementById('chat-input');
  const q = input.value.trim();
  if (!q) return;
  input.value = '';
  ask(q);
}

async function ask(q) {
  document.getElementById('chat-input').value = '';
  appendMsg(q, 'user');
  const loadDiv = appendMsg('×—×•×©×‘â€¦', 'bot loading');
  document.getElementById('send-btn').disabled = true;

  try {
    if (!busCache.length)  busCache  = await apiFetch('/buses').catch(() => []);
    if (!stopCache.length) stopCache = await apiFetch('/stops').catch(() => []);
    const { text, html } = await agentAnswer(q.trim(), busCache, stopCache);
    loadDiv.className = 'msg bot';
    if (html) { loadDiv.innerHTML = html; }
    else      { loadDiv.textContent = text; }
  } catch(err) {
    loadDiv.className = 'msg bot';
    loadDiv.textContent = `×©×’×™××”: ${err.message}`;
  }
  document.getElementById('send-btn').disabled = false;
}

// Extract leading/trailing number from query (e.g. "×§×• 1", "××•×˜×•×‘×•×¡ 480", "route 5")
function extractRouteNum(q) {
  const m = q.match(/(\d+)/);
  return m ? m[1] : null;
}

// Fuzzy-match a keyword against an array of buses
function busesForRoute(buses, routeNum) {
  return buses.filter(b =>
    String(b.route_id ?? '').includes(routeNum) ||
    String(b.vehicle_id ?? '').includes(routeNum) ||
    String(b.trip_id ?? '').includes(routeNum)
  );
}

function busesForStop(buses, keyword) {
  const kl = keyword.toLowerCase();
  return buses.filter(b =>
    (b.nearest_stop_name ?? '').toLowerCase().includes(kl)
  );
}

function formatBusList(matches, label) {
  if (!matches.length) return { text: `×œ× × ××¦××• ××•×˜×•×‘×•×¡×™× ×‘×©×‘×™×œ "${label}".` };
  const lines = matches.slice(0, 10).map(b =>
    `â€¢ ID ${b.vehicle_id} | ×§×• ${b.route_id} | ${b.lat?.toFixed(4)},${b.lon?.toFixed(4)} | ${b.nearest_stop_name ?? 'â€“'} (${b.distance_to_stop_m != null ? Math.round(b.distance_to_stop_m)+'×\'' : 'â€“'})`
  );
  const extra = matches.length > 10 ? `\n+${matches.length-10} × ×•×¡×¤×™×` : '';
  return { text: `× ××¦××• ${matches.length} ××•×˜×•×‘×•×¡×™× (${label}):\n` + lines.join('\n') + extra };
}

// Geocode an Israeli address using Nominatim and find nearest buses
async function geocodeAndFindBuses(address, buses) {
  const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address + ', Israel')}&format=json&limit=1`;
  const resp = await fetch(url, { headers: { 'Accept-Language': 'he' } });
  const data = await resp.json();
  if (!data.length) return null;

  const lat = parseFloat(data[0].lat);
  const lon = parseFloat(data[0].lon);
  const displayName = data[0].display_name.split(',')[0];

  // calculate dist from address to each bus
  function haversine(la1, lo1, la2, lo2) {
    const R = 6371000, rad = Math.PI/180;
    const dLat = (la2-la1)*rad, dLon = (lo2-lo1)*rad;
    const a = Math.sin(dLat/2)**2 + Math.cos(la1*rad)*Math.cos(la2*rad)*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }

  const withDist = buses
    .filter(b => b.lat != null && b.lon != null)
    .map(b => ({ ...b, _addrDist: haversine(lat, lon, b.lat, b.lon) }))
    .sort((a,b) => a._addrDist - b._addrDist)
    .slice(0, 10);

  return { displayName, lat, lon, withDist };
}

async function agentAnswer(q, buses, stops) {
  const lq = q.toLowerCase();

  // â”€â”€ Bus / Route number search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const isRouteQuery = /×§×•|route|××•×˜×•×‘×•×¡\s*\d|bus\s*\d|××¡×¤×¨ ×§×•/.test(lq);
  const routeNum = extractRouteNum(q);

  if (isRouteQuery && routeNum) {
    const matches = busesForRoute(buses, routeNum);
    setFilter(`×§×• ${routeNum}`, matches);
    if (!matches.length)
      return { text: `×œ× × ××¦××• ××•×˜×•×‘×•×¡×™× ×¤×¢×™×œ×™× ×‘×§×• ${routeNum} ×›×¨×’×¢.\n× ×¡×” ×§×• ××—×¨ ××• ×‘×“×•×§ ×××•×—×¨ ×™×•×ª×¨.` };
    const first = matches[0];
    const speeds = matches.map(b=>b.velocity).filter(v=>v!=null&&v>0);
    const avgSpd = speeds.length ? (speeds.reduce((a,b)=>a+b,0)/speeds.length).toFixed(1) : 'â€“';
    const lines = matches.slice(0,8).map(b=>
      `â€¢ ×¨×›×‘ ${b.vehicle_id} | ${b.lat?.toFixed(4)},${b.lon?.toFixed(4)} | ×ª×—× ×”: ${b.nearest_stop_name??'â€“'}`
    );
    return { text:
      `×§×• ${routeNum} â€” ${matches.length} ××•×˜×•×‘×•×¡×™× ×¤×¢×™×œ×™×:\n` +
      lines.join('\n') +
      (matches.length>8 ? `\n+${matches.length-8} × ×•×¡×¤×™×` : '') +
      `\n××”×™×¨×•×ª ×××•×¦×¢×ª: ${avgSpd} ×§×"×©`
    };
  }

  // â”€â”€ Address / stop name search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Patterns: "×ª×—× ×”: X", "×›×ª×•×‘×ª: X", "×œ×™×“ X", "×‘××™×–×•×¨ X", "×‘XX"
  const addrMatch = q.match(/(?:×ª×—× ×”|×›×ª×•×‘×ª|×œ×™×“|×‘××™×–×•×¨|near|address|stop)[:ï¼š\s]+(.+)/i)
                 || q.match(/^([\u0590-\u05FF\w][\u0590-\u05FF\w\s,]{3,})$/);

  if (addrMatch) {
    const keyword = (addrMatch[1] ?? addrMatch[0]).trim();

    // 1) first try local stop-name match
    const stopMatches = busesForStop(buses, keyword);
    if (stopMatches.length) {
      setFilter(`×ª×—× ×”: ${keyword}`, stopMatches);
      const lines = stopMatches.slice(0,8).map(b=>
        `â€¢ ×§×• ${b.route_id} | ×¨×›×‘ ${b.vehicle_id} | ××¨×—×§ ${b.distance_to_stop_m!=null?Math.round(b.distance_to_stop_m)+'×\'':'â€“'}`
      );
      return { text:
        `× ××¦××• ${stopMatches.length} ××•×˜×•×‘×•×¡×™× ×œ×™×“ "${keyword}":\n` +
        lines.join('\n') +
        (stopMatches.length>8 ? `\n+${stopMatches.length-8} × ×•×¡×¤×™×` : '')
      };
    }

    // 2) geocode via Nominatim
    try {
      const geo = await geocodeAndFindBuses(keyword, buses);
      if (geo && geo.withDist.length) {
        setFilter(`×œ×™×“ ${geo.displayName}`, geo.withDist);
        const lines = geo.withDist.slice(0,8).map(b=>
          `â€¢ ×§×• ${b.route_id} | ×¨×›×‘ ${b.vehicle_id} | ${Math.round(b._addrDist)}×' ××”×›×ª×•×‘×ª | ×ª×—× ×”: ${b.nearest_stop_name??'â€“'}`
        );
        return { text:
          `××•×˜×•×‘×•×¡×™× ×”×§×¨×•×‘×™× ×œ"${geo.displayName}":\n` +
          lines.join('\n')
        };
      } else if (geo) {
        return { text: `××¦××ª×™ ××ª ×”×›×ª×•×‘×ª "${geo.displayName}" ××‘×œ ××™×Ÿ ××•×˜×•×‘×•×¡×™× ×‘×§×¨×‘×ª ××§×•× ×›×¨×’×¢.` };
      }
    } catch(e) { /* geocoding unavailable */ }

    return { text: `×œ× × ××¦××• ×ª×•×¦××•×ª ×¢×‘×•×¨ "${keyword}".\n× ×¡×” ×©× ×ª×—× ×”, ×§×• ××¡×¤×¨ (×§×• 1), ××• ×›×ª×•×‘×ª ×™×“×•×¢×”.` };
  }

  // â”€â”€ Count â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (/×›××”|how many|××¡×¤×¨/.test(lq))
    return { text: `×™×©× × ${buses.length} ××•×˜×•×‘×•×¡×™× ×¤×¢×™×œ×™× ×›×¨×’×¢ ×‘××¢×¨×›×ª.` };

  // â”€â”€ All routes list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (/×›×œ ×”×§×•×•|all route|×¨×©×™××ª ×§×•×•/.test(lq)) {
    const routes = [...new Set(buses.map(b=>b.route_id).filter(Boolean))].sort();
    return { text: `×§×•×•×™× ×¤×¢×™×œ×™× (${routes.length}):\n${routes.slice(0,40).join(', ')}${routes.length>40?'â€¦':''}` };
  }

  // â”€â”€ Speed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (/××”×™×¨×•×ª|speed|velocity/.test(lq)) {
    const speeds = buses.map(b=>b.velocity).filter(v=>v!=null&&v>0);
    if (!speeds.length) return { text: '××™×Ÿ × ×ª×•× ×™ ××”×™×¨×•×ª ×–××™× ×™× ×›×¨×’×¢.' };
    const avg = (speeds.reduce((a,b)=>a+b,0)/speeds.length).toFixed(1);
    const max = Math.max(...speeds).toFixed(1);
    return { text: `××”×™×¨×•×ª ×××•×¦×¢×ª: ${avg} ×§×"×©\n××”×™×¨×•×ª ××§×¡×™××œ×™×ª: ${max} ×§×"×©\n(××ª×•×š ${speeds.length} ×›×œ×™ ×¨×›×‘)` };
  }

  // â”€â”€ Nearest stop to me â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (/×§×¨×•×‘|nearest|×œ×™×“/.test(lq)) {
    const withStop = buses.filter(b=>b.nearest_stop_name)
      .sort((a,b)=>(a.distance_to_stop_m??Infinity)-(b.distance_to_stop_m??Infinity));
    if (!withStop.length) return { text: '××™×Ÿ × ×ª×•× ×™ ×ª×—× ×” ×§×¨×•×‘×” ×–××™× ×™×.' };
    const b = withStop[0];
    return { text: `×”××•×˜×•×‘×•×¡ ×”×§×¨×•×‘ ×‘×™×•×ª×¨ ×œ×ª×—× ×”:\nâ€¢ ID: ${b.vehicle_id}\nâ€¢ ×§×•: ${b.route_id}\nâ€¢ ×ª×—× ×”: ${b.nearest_stop_name}\nâ€¢ ××¨×—×§: ${Math.round(b.distance_to_stop_m)}×'` };
  }

  // â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (/×¡×˜×˜×•×¡|status|×©×™×¨×•×ª|××¦×‘/.test(lq))
    return { text: `××¦×‘ ×”××¢×¨×›×ª:\nâ€¢ Bot API: ×¤×¢×™×œ âœ…\nâ€¢ ××•×˜×•×‘×•×¡×™×: ${buses.length}\nâ€¢ ××§×•×¨: ${buses[0]?.source ?? 'â€“'}` };

  // â”€â”€ Source â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (/××§×•×¨|source|api|siri|gtfs/.test(lq)) {
    const src = buses[0]?.source;
    return { text: src === 'hasadna-siri'
      ? '×”× ×ª×•× ×™× ××’×™×¢×™× ×-Hasadna Open Bus SIRI API âœ…\n(MOT GTFS-RT ×œ× ×–××™×Ÿ â€” ××—×–×™×¨ ×¢××•×“ ×©×’×™××”)'
      : `××§×•×¨ × ×ª×•× ×™×: ${src ?? '×œ× ×™×“×•×¢'}` };
  }

  // â”€â”€ Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  return { html:
    `<b>×©×œ×•×! ×× ×™ ×¡×•×›×Ÿ ×”×ª×—×‘×•×¨×” ğŸšŒ</b><br>×× ×™ ×™×›×•×œ ×œ×¢× ×•×ª ×¢×œ:<br>` +
    `â€¢ <span class="chip" onclick="ask('×§×• 1')" style="cursor:pointer">×§×• 1</span> â€” ×—×™×¤×•×© ×œ×¤×™ ××¡×¤×¨ ×§×•<br>` +
    `â€¢ <span class="chip" onclick="ask('×ª×—× ×”: ×“×™×–× ×’×•×£')" style="cursor:pointer">×ª×—× ×”: ×“×™×–× ×’×•×£</span> â€” ×—×™×¤×•×© ×œ×¤×™ ×©× ×ª×—× ×” ××• ×›×ª×•×‘×ª<br>` +
    `â€¢ <span class="chip" onclick="ask('×›××” ××•×˜×•×‘×•×¡×™× ×¤×¢×™×œ×™×?')" style="cursor:pointer">×›××” ××•×˜×•×‘×•×¡×™×?</span> â€” ×¡×˜×˜×™×¡×˜×™×§×” ×›×œ×œ×™×ª<br>` +
    `â€¢ <span class="chip" onclick="ask('××”×™×¨×•×ª ×××•×¦×¢×ª')" style="cursor:pointer">××”×™×¨×•×ª</span> â€” × ×ª×•× ×™ ××”×™×¨×•×ª<br>` +
    `â€¢ <span class="chip" onclick="ask('×”×¦×’ ×›×œ ×”×§×•×•×™×')" style="cursor:pointer">×›×œ ×”×§×•×•×™×</span> â€” ×¨×©×™××ª ×§×•×•×™× ×¤×¢×™×œ×™×`
  };
}

// â”€â”€ Stop count from /stops endpoint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStopCount() {
  try {
    const stops = await apiFetch('/stops');
    setCard('kpi-stops', 'ok', stops.length);
  } catch { setCard('kpi-stops', 'warn', 'â€“'); }
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  await loadHealth();
  await Promise.all([loadBuses(), loadStopCount(), checkServices()]);
  // auto-refresh every 30s
  setInterval(async () => {
    busCache = []; stopCache = [];
    await loadHealth();
    await Promise.all([loadBuses(), loadStopCount()]);
  }, 30000);
})();
</script>

</body>
</html>
