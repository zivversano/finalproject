<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Israel Transit Query Tool ğŸšŒ</title>
  <style>
    :root {
      --bg:       #0d1117;
      --surface:  #161b22;
      --surface2: #1c2128;
      --border:   #30363d;
      --accent:   #1f6feb;
      --green:    #3fb950;
      --yellow:   #d29922;
      --orange:   #e3891e;
      --red:      #f85149;
      --cyan:     #39c5cf;
      --text:     #e6edf3;
      --muted:    #8b949e;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Header */
    header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 { font-size: 1.2rem; font-weight: 700; }
    header h1 span { color: var(--accent); }
    #live-badge {
      display: flex; align-items: center; gap: 6px;
      font-size: .78rem; color: var(--muted);
    }
    #live-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--green);
      animation: pulse 1.6s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.3} }

    /* Nav tabs */
    nav {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex; gap: 0; overflow-x: auto;
    }
    nav button {
      background: none; border: none; border-bottom: 3px solid transparent;
      color: var(--muted); cursor: pointer;
      padding: 12px 20px; font-size: .9rem; white-space: nowrap;
      transition: color .2s, border-color .2s;
    }
    nav button:hover { color: var(--text); }
    nav button.active { color: var(--accent); border-bottom-color: var(--accent); }

    /* Layout */
    main { padding: 24px; max-width: 960px; margin: 0 auto; }
    .tab-panel { display: none; flex-direction: column; gap: 18px; }
    .tab-panel.active { display: flex; }

    /* Search bar */
    .search-row {
      display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;
    }
    .search-row .field { display: flex; flex-direction: column; gap: 4px; flex: 1; min-width: 180px; }
    .search-row label { font-size: .78rem; color: var(--muted); }
    .search-row input, .search-row select {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text);
      padding: 9px 12px; font-size: .9rem; outline: none;
      transition: border-color .2s;
    }
    .search-row input:focus, .search-row select:focus { border-color: var(--accent); }
    .btn {
      background: var(--accent); color: #fff; border: none;
      border-radius: 8px; padding: 9px 20px; cursor: pointer;
      font-size: .9rem; font-weight: 600; white-space: nowrap;
      transition: opacity .2s; align-self: flex-end;
    }
    .btn:hover { opacity: .85; }
    .btn:disabled { opacity: .4; cursor: default; }

    /* Quick chips */
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 20px; padding: 4px 14px; font-size: .8rem;
      cursor: pointer; color: var(--muted); transition: border-color .2s, color .2s;
    }
    .chip:hover { border-color: var(--accent); color: var(--text); }

    /* Loading */
    .loader {
      display: flex; align-items: center; gap: 10px;
      color: var(--muted); font-size: .9rem; padding: 12px 0;
    }
    .spinner {
      width: 18px; height: 18px; border-radius: 50%;
      border: 2px solid var(--border); border-top-color: var(--accent);
      animation: spin .8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Vehicle cards */
    .v-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; padding: 14px 16px;
      display: flex; flex-direction: column; gap: 6px;
    }
    .v-card .v-header {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    .v-card .line-badge {
      background: var(--accent); color: #fff;
      border-radius: 6px; padding: 2px 10px;
      font-weight: 700; font-size: 1rem;
    }
    .v-card .op-name { color: var(--cyan); font-size: .88rem; }
    .v-card .age     { color: var(--muted); font-size: .78rem; margin-right: auto; }
    .v-card .v-row   { font-size: .85rem; color: var(--muted); display: flex; gap: 16px; flex-wrap: wrap; }
    .v-card .v-row span { color: var(--text); }
    .badge-ok   { color: var(--green); }
    .badge-warn { color: var(--yellow); }
    .badge-bad  { color: var(--orange); }
    .badge-err  { color: var(--red); }

    /* Alert card */
    .alert-card {
      background: var(--surface); border: 1px solid var(--border);
      border-right: 4px solid var(--red); border-radius: 10px;
      padding: 14px 16px; display: flex; flex-direction: column; gap: 6px;
    }
    .alert-card .a-title { font-weight: 600; font-size: .95rem; }
    .alert-card .a-effect { color: var(--orange); font-size: .82rem; }

    /* Train board row */
    .train-row {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px 16px;
      display: grid; grid-template-columns: auto 1fr auto; gap: 6px 14px;
      align-items: center;
    }
    .train-row .tn { font-weight: 700; font-size: 1.05rem; }
    .train-row .route { font-size: .88rem; }
    .train-row .platform {
      background: var(--yellow); color: #000;
      border-radius: 6px; padding: 2px 8px; font-weight: 700; font-size: .85rem;
      text-align: center;
    }
    .train-row .times { font-size: .83rem; color: var(--muted); grid-column: 1/-1; }
    .train-row .times span { color: var(--text); }

    /* Empty / error states */
    .msg-box {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 10px; padding: 20px; text-align: center;
      color: var(--muted); font-size: .9rem;
    }
    .msg-box.err  { border-color: var(--red);    color: var(--red); }
    .msg-box.warn { border-color: var(--yellow); color: var(--yellow); }
    .msg-box.ok   { border-color: var(--green);  color: var(--green); }

    /* Summary bar */
    .summary { font-size: .82rem; color: var(--muted); padding: 4px 0; }

    /* Station grid */
    .station-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 8px;
    }
    .station-btn {
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; padding: 8px 12px; cursor: pointer;
      color: var(--text); font-size: .82rem; text-align: right;
      transition: border-color .2s;
    }
    .station-btn:hover { border-color: var(--accent); }
    .station-btn .s-id { color: var(--cyan); font-weight: 700; font-size: .9rem; }

    code { font-family: monospace; font-size: .82rem; }
  </style>
</head>
<body>

<header>
  <h1>ğŸšŒ <span>Israel</span> Transit Query Tool</h1>
  <div id="live-badge">
    <div id="live-dot"></div>
    <span id="live-time">--:--:--</span>
  </div>
</header>

<nav>
  <button class="active" data-tab="tab-bus"     onclick="switchTab('tab-bus',this)">ğŸ“ ×œ×™×“ ×›×ª×•×‘×ª</button>
  <button               data-tab="tab-line"    onclick="switchTab('tab-line',this)">ğŸšŒ ×§×• ××•×˜×•×‘×•×¡</button>
  <button               data-tab="tab-station" onclick="switchTab('tab-station',this)">ğŸš† ×œ×•×— ×¨×›×‘×ª</button>
  <button               data-tab="tab-train"   onclick="switchTab('tab-train',this)">ğŸ” ×¢×§×‘ ×¨×›×‘×ª</button>
  <button               data-tab="tab-alerts"  onclick="switchTab('tab-alerts',this)">ğŸ”” ×”×ª×¨××•×ª</button>
</nav>

<main>

  <!-- Tab 1: Buses near address -->
  <div id="tab-bus" class="tab-panel active">
    <div class="search-row">
      <div class="field">
        <label>×›×ª×•×‘×ª (×¢×‘×¨×™×ª ××• ×× ×’×œ×™×ª)</label>
        <input id="addr-input" type="text" placeholder="×¨×—×•×‘ ×”×¨×¦×œ 1, ×ª×œ ××‘×™×‘" />
      </div>
      <div class="field" style="max-width:130px">
        <label>×˜×•×•×— (××˜×¨×™×)</label>
        <input id="addr-radius" type="number" value="500" min="100" max="3000" step="100" />
      </div>
      <button class="btn" onclick="searchNearAddress()">×—×™×¤×•×©</button>
    </div>
    <div class="chips">
      <span class="chip" onclick="quickAddr('×“×™×–× ×’×•×£ 50, ×ª×œ ××‘×™×‘')">ğŸ“ ×“×™×–× ×’×•×£ ×ª"×</span>
      <span class="chip" onclick="quickAddr('×›×™×›×¨ ×¡×¤×¨×, ×™×¨×•×©×œ×™×')">ğŸ“ ×›×™×›×¨ ×¡×¤×¨×</span>
      <span class="chip" onclick="quickAddr('×”× ××œ, ×—×™×¤×”')">ğŸ“ × ××œ ×—×™×¤×”</span>
      <span class="chip" onclick="quickAddr('×©×“×¨×•×ª ×‘×Ÿ ×’×•×¨×™×•×Ÿ, ×‘××¨ ×©×‘×¢')">ğŸ“ ×‘"×’ ×‘××¨ ×©×‘×¢</span>
      <span class="chip" onclick="quickAddr('×¨×—×•×‘ ×•×™×¦××Ÿ, ×¨×—×•×‘×•×ª')">ğŸ“ ×•×™×¦××Ÿ ×¨×—×•×‘×•×ª</span>
    </div>
    <div id="results-bus"></div>
  </div>

  <!-- Tab 2: Track bus line -->
  <div id="tab-line" class="tab-panel">
    <div class="search-row">
      <div class="field" style="max-width:160px">
        <label>××¡×¤×¨ ×§×• ××•×˜×•×‘×•×¡</label>
        <input id="line-input" type="text" placeholder="89" />
      </div>
      <div class="field" style="max-width:190px">
        <label>××¤×¢×™×œ (××•×¤×¦×™×•× ×œ×™)</label>
        <select id="line-operator">
          <option value="">×›×œ ×”××¤×¢×™×œ×™×</option>
          <option value="3">3 â€” ×“×Ÿ</option>
          <option value="5">5 â€” ××’×“</option>
          <option value="14">14 â€” ××˜×¨×•×¤×•×œ×™×Ÿ</option>
          <option value="21">21 â€” ×§×•×•×™×</option>
          <option value="25">25 â€” × ×ª×™×‘ ××§×¡×¤×¨×¡</option>
          <option value="42">42 â€” ×§×•× ×§×˜</option>
        </select>
      </div>
      <button class="btn" onclick="searchLine()">×¢×§×•×‘</button>
    </div>
    <div class="chips">
      <span class="chip" onclick="quickLine('1')">×§×• 1</span>
      <span class="chip" onclick="quickLine('89')">×§×• 89</span>
      <span class="chip" onclick="quickLine('480')">×§×• 480</span>
      <span class="chip" onclick="quickLine('271')">×§×• 271</span>
      <span class="chip" onclick="quickLine('51')">×§×• 51</span>
      <span class="chip" onclick="quickLine('240')">×§×• 240</span>
    </div>
    <div id="results-line"></div>
  </div>

  <!-- Tab 3: Train station board -->
  <div id="tab-station" class="tab-panel">
    <div class="search-row">
      <div class="field" style="max-width:200px">
        <label>××¡×¤×¨ ×ª×—× ×”</label>
        <input id="station-input" type="text" placeholder="2300" />
      </div>
      <button class="btn" onclick="searchStation()">×œ×•×— ×™×¦×™××•×ª</button>
    </div>
    <div class="station-grid">
      <button class="station-btn" onclick="quickStation('2300')"><div class="s-id">2300</div>×ª×œ ××‘×™×‘ ××¨×›×–</button>
      <button class="station-btn" onclick="quickStation('2820')"><div class="s-id">2820</div>×ª×œ ××‘×™×‘ ×”×©×œ×•×</button>
      <button class="station-btn" onclick="quickStation('3400')"><div class="s-id">3400</div>×™×¨×•×©×œ×™× × ×‘×•×Ÿ</button>
      <button class="station-btn" onclick="quickStation('3600')"><div class="s-id">3600</div>×—×™×¤×” ××¨×›×– ×©××™×¨</button>
      <button class="station-btn" onclick="quickStation('3100')"><div class="s-id">3100</div>× ×ª× ×™×”</button>
      <button class="station-btn" onclick="quickStation('5000')"><div class="s-id">5000</div>×”×¨×¦×œ×™×”</button>
      <button class="station-btn" onclick="quickStation('4600')"><div class="s-id">4600</div>×‘××¨ ×©×‘×¢ ××¨×›×–</button>
      <button class="station-btn" onclick="quickStation('1220')"><div class="s-id">1220</div>× ×”×¨×™×”</button>
      <button class="station-btn" onclick="quickStation('700')"><div class="s-id">700</div>×—×“×¨×” ××¢×¨×‘</button>
      <button class="station-btn" onclick="quickStation('6700')"><div class="s-id">6700</div>××©×§×œ×•×Ÿ</button>
      <button class="station-btn" onclick="quickStation('6900')"><div class="s-id">6900</div>××©×“×•×“ ×¢×“ ×”×œ×•×</button>
      <button class="station-btn" onclick="quickStation('2200')"><div class="s-id">2200</div>×‘× ×™ ×‘×¨×§</button>
    </div>
    <div id="results-station"></div>
  </div>

  <!-- Tab 4: Track train by number -->
  <div id="tab-train" class="tab-panel">
    <div class="search-row">
      <div class="field" style="max-width:200px">
        <label>××¡×¤×¨ ×¨×›×‘×ª</label>
        <input id="train-input" type="text" placeholder="145" />
      </div>
      <button class="btn" onclick="trackTrain()">×¢×§×•×‘</button>
    </div>
    <p style="font-size:.82rem;color:var(--muted)">××—×¤×© ××ª ×”×¨×›×‘×ª ×‘×›×œ ×”×ª×—× ×•×ª ×”×¨××©×™×•×ª ×‘×–××Ÿ ×××ª.</p>
    <div id="results-train"></div>
  </div>

  <!-- Tab 5: Service alerts -->
  <div id="tab-alerts" class="tab-panel">
    <div class="search-row">
      <button class="btn" onclick="loadAlerts()">×¨×¢× ×Ÿ ×”×ª×¨××•×ª</button>
    </div>
    <div id="results-alerts"></div>
  </div>

</main>

<script>
// â”€â”€ Constants (same as transit_query.py) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const OPEN_BUS_BASE = "https://open-bus-stride-api.hasadna.org.il";
const RAIL_BOARD    = "https://israelrail.azurewebsites.net/stations/GetStationBoard";
const NOMINATIM     = "https://nominatim.openstreetmap.org/search";

const OPERATORS = {
  "3":"×“×Ÿ","5":"××’×“","7":"××’×“ ×ª×¢×•×¤×”","14":"××˜×¨×•×¤×•×œ×™×Ÿ",
  "21":"×§×•×•×™×","25":"× ×ª×™×‘ ××§×¡×¤×¨×¡","42":"×§×•× ×§×˜","16":"×’×‘×¢×”",
};
const TRAIN_STATIONS = {
  "2300":"×ª×œ ××‘×™×‘ ××¨×›×–","2820":"×ª×œ ××‘×™×‘ ×”×©×œ×•×","3400":"×™×¨×•×©×œ×™× × ×‘×•×Ÿ",
  "3600":"×—×™×¤×” ××¨×›×– ×©××™×¨","3100":"× ×ª× ×™×”","5000":"×”×¨×¦×œ×™×”",
  "5010":"×¨×¢× × ×” ×‘","4600":"×‘××¨ ×©×‘×¢ ××¨×›×–","1220":"× ×”×¨×™×”","700":"×—×“×¨×” ××¢×¨×‘",
  "2500":"×¤×ª×— ×ª×§×•×•×” ×¡×¤×™×¨","2200":"×‘× ×™ ×‘×¨×§","4900":"×“×™××•× ×”","3500":"×¢×›×•",
  "6700":"××©×§×œ×•×Ÿ","6900":"××©×“×•×“ ×¢×“ ×”×œ×•×",
};

// â”€â”€ Clock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(() => {
  document.getElementById("live-time").textContent =
    new Date().toLocaleTimeString("he-IL");
}, 1000);

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(id, btn) {
  document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  btn.classList.add("active");
}

// â”€â”€ Utility helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000, toR = d => d * Math.PI / 180;
  const dlat = toR(lat2-lat1), dlon = toR(lon2-lon1);
  const a = Math.sin(dlat/2)**2 + Math.cos(toR(lat1))*Math.cos(toR(lat2))*Math.sin(dlon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function ageStr(iso) {
  if (!iso) return "â€”";
  try {
    const sec = Math.floor((Date.now() - new Date(iso).getTime()) / 1000);
    if (sec < 0)  return "×¢×›×©×™×•";
    if (sec < 60) return `${sec}×©' ×œ×¤× ×™`;
    return `${Math.floor(sec/60)}×“×§' ×œ×¤× ×™`;
  } catch { return "â€”"; }
}

function bearingDir(b) {
  if (b == null) return "";
  const dirs = ["â†‘N","â†—NE","â†’E","â†˜SE","â†“S","â†™SW","â†W","â†–NW"];
  return dirs[Math.round(((+b % 360) + 22.5) / 45) % 8];
}

function statusBadge(delaySec, cancelled) {
  if (cancelled)       return `<span class="badge-err">âŒ ×‘×•×˜×œ</span>`;
  if (delaySec == null) return `<span class="badge-warn">â“ ××™×Ÿ ××™×“×¢</span>`;
  if (delaySec <= 60)  return `<span class="badge-ok">âœ… ×‘×–××Ÿ</span>`;
  const m = Math.floor(delaySec/60);
  if (delaySec <= 300) return `<span class="badge-warn">ğŸŸ¡ ${m} ×“×§' ××™×—×•×¨</span>`;
  if (delaySec <= 900) return `<span class="badge-bad">ğŸŸ  ${m} ×“×§' ××™×—×•×¨</span>`;
  return `<span class="badge-err">ğŸ”´ ${m} ×“×§' ××™×—×•×¨</span>`;
}

function setLoading(el) {
  el.innerHTML = `<div class="loader"><div class="spinner"></div> ×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>`;
}
function setMsg(el, text, type="") {
  el.innerHTML = `<div class="msg-box ${type}">${text}</div>`;
}

// Geocode via Nominatim (same logic as transit_query.py)
async function geocode(address) {
  const q = /×™×©×¨|israel/i.test(address) ? address : `${address}, Israel`;
  const r = await fetch(`${NOMINATIM}?q=${encodeURIComponent(q)}&format=json&limit=1&accept-language=he`);
  const data = await r.json();
  if (!data.length) return null;
  return { lat: +data[0].lat, lon: +data[0].lon, name: data[0].display_name };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Tab 1 â€” Buses near address  (find_buses_near_address)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function quickAddr(a) { document.getElementById("addr-input").value = a; searchNearAddress(); }

async function searchNearAddress() {
  const addr   = document.getElementById("addr-input").value.trim();
  const radius = parseInt(document.getElementById("addr-radius").value) || 500;
  const out    = document.getElementById("results-bus");
  if (!addr) { setMsg(out, "×”×›× ×¡ ×›×ª×•×‘×ª ×œ×—×™×¤×•×©", "warn"); return; }

  setLoading(out);

  // Step 1 â€” geocode via Nominatim
  let geo;
  try { geo = await geocode(addr); }
  catch(e) { setMsg(out, `âŒ ×©×’×™××ª Nominatim: ${e.message}`, "err"); return; }
  if (!geo) { setMsg(out, "âŒ ×”×›×ª×•×‘×ª ×œ× × ××¦××”. × ×¡×” × ×™×¡×•×— ××—×¨.", "err"); return; }

  // Step 2 â€” Open Bus Stride siri_vehicle_locations/list (bounding box)
  const deg_m = 0.00001;  // ~1m per 0.00001 deg lat
  const lat_d = (radius * deg_m) * 1.2;
  const lon_d = (radius * deg_m) * 1.5;
  let vehicles = [];
  try {
    const url = `${OPEN_BUS_BASE}/siri_vehicle_locations/list?` +
      `lon__greater_or_equal=${(geo.lon - lon_d).toFixed(5)}&lon__lower_or_equal=${(geo.lon + lon_d).toFixed(5)}` +
      `&lat__greater_or_equal=${(geo.lat - lat_d).toFixed(5)}&lat__lower_or_equal=${(geo.lat + lat_d).toFixed(5)}` +
      `&limit=100&order_by=id desc`;
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    vehicles = await r.json();
  } catch(e) {
    setMsg(out, `âŒ ×©×’×™××ª Open Bus Stride: ${e.message}`, "err"); return;
  }

  // Filter by exact haversine distance
  vehicles = vehicles
    .map(v => ({ ...v, _dist: haversine(geo.lat, geo.lon, +v.lat, +v.lon) }))
    .filter(v => v._dist <= radius)
    .sort((a, b) => a._dist - b._dist);

  if (!vehicles.length) {
    setMsg(out, `âš ï¸ ×œ× × ××¦××• ××•×˜×•×‘×•×¡×™× ×‘×˜×•×•×— ${radius}×' ×: ${geo.name.slice(0,60)}`, "warn");
    return;
  }

  let html = `<div class="summary">ğŸ“ ${geo.name.slice(0,80)} &nbsp;|&nbsp; × ××¦××• ${vehicles.length} ×¨×›×‘×™× ×‘×˜×•×•×— ${radius}×'</div>`;
  for (const v of vehicles) {
    const line   = v.line_ref || "â€”";
    const opId   = String(v.operator_ref || "");
    const opName = OPERATORS[opId] || `××¤×¢×™×œ ${opId}`;
    const bearing = bearingDir(v.bearing);
    const spd    = v.velocity != null ? `ğŸ’¨ ${(+v.velocity).toFixed(0)} ×§×"×© &nbsp;` : "";
    const atStop = v.at_stop ? `ğŸ›‘ <span style="color:var(--yellow)">×¢×¦×¨×ª×™ ×‘×ª×—× ×”</span>` : "";
    const dest   = v.destination_ref ? `ğŸ¯ ${v.destination_ref} &nbsp;` : "";
    html += `
    <div class="v-card">
      <div class="v-header">
        <span class="line-badge">×§×• ${line}</span>
        <span class="op-name">${opName}</span>
        <span class="age">${Math.round(v._dist)}×' ×××š &nbsp; ${bearing} &nbsp; ×¢×“×›×•×Ÿ: ${ageStr(v.recorded_at_time)}</span>
      </div>
      <div class="v-row">${dest}${spd}${atStop}</div>
    </div>`;
  }
  out.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Tab 2 â€” Track bus line  (track_bus_line)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function quickLine(n) { document.getElementById("line-input").value = n; searchLine(); }

async function searchLine() {
  const line = document.getElementById("line-input").value.trim();
  const opId = document.getElementById("line-operator").value;
  const out  = document.getElementById("results-line");
  if (!line) { setMsg(out, "×”×›× ×¡ ××¡×¤×¨ ×§×•", "warn"); return; }

  setLoading(out);

  let url = `${OPEN_BUS_BASE}/siri_vehicle_locations/list?line_ref=${encodeURIComponent(line)}&limit=100&order_by=id desc`;
  if (opId) url += `&operator_ref=${opId}`;

  let vehicles = [];
  try {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    vehicles = await r.json();
  } catch(e) {
    setMsg(out, `âŒ ×©×’×™××ª Open Bus Stride: ${e.message}`, "err"); return;
  }

  if (!vehicles.length) {
    setMsg(out, `âš ï¸ ×œ× × ××¦××• ×¨×›×‘×™× ×¤×¢×™×œ×™× ×‘×§×• ${line}. ×™×™×ª×›×Ÿ ×©×”×§×• ××™× ×• ×¤×¢×™×œ ×›×¨×’×¢.`, "warn");
    return;
  }

  // Group by direction (same as track_bus_line in script)
  const byDir = {};
  for (const v of vehicles) {
    const d = String(v.direction_ref ?? v.direction_id ?? "0");
    (byDir[d] = byDir[d] || []).push(v);
  }

  let html = `<div class="summary">ğŸšŒ ×§×• ${line} â€” ${vehicles.length} ×¨×›×‘×™× ×¤×¢×™×œ×™×</div>`;
  for (const [dir, vlist] of Object.entries(byDir)) {
    const label = dir === "0" ? "×›×™×•×•×Ÿ ××³" : dir === "1" ? "×›×™×•×•×Ÿ ×‘×³" : `×›×™×•×•×Ÿ ${dir}`;
    html += `<div style="font-size:.85rem;font-weight:600;color:var(--cyan);margin:8px 0 4px">${label} (${vlist.length} ×¨×›×‘×™×)</div>`;
    for (const v of vlist) {
      const opName = OPERATORS[String(v.operator_ref||"")] || `××¤×¢×™×œ ${v.operator_ref||""}`;
      const dir2   = bearingDir(v.bearing);
      const spd    = v.velocity != null ? `ğŸ’¨ ${(+v.velocity).toFixed(0)} ×§×"×© &nbsp;` : "";
      const atStop = v.at_stop ? `ğŸ›‘ <span style="color:var(--yellow)">×¢×¦×¨×ª×™ ×‘×ª×—× ×” ${v.stop_id||""}</span>` : "";
      const coord  = v.lat ? `ğŸ“ ${(+v.lat).toFixed(5)}, ${(+v.lon).toFixed(5)}` : "";
      html += `
      <div class="v-card">
        <div class="v-header">
          <span class="line-badge">×§×• ${v.line_ref || line}</span>
          <span class="op-name">${opName}</span>
          <span class="age">${dir2} &nbsp; ×¢×“×›×•×Ÿ: ${ageStr(v.recorded_at_time)}</span>
        </div>
        <div class="v-row">${coord} &nbsp; ${spd}${atStop}</div>
      </div>`;
    }
  }
  out.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Tab 3 â€” Train station board  (get_train_station)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function quickStation(sid) { document.getElementById("station-input").value = sid; searchStation(); }

async function searchStation() {
  const sid  = document.getElementById("station-input").value.trim();
  const out  = document.getElementById("results-station");
  if (!sid) { setMsg(out, "×”×›× ×¡ ××¡×¤×¨ ×ª×—× ×”", "warn"); return; }

  const sName = TRAIN_STATIONS[sid] || `×ª×—× ×” ${sid}`;
  setLoading(out);

  const today = new Date().toISOString().slice(0,10);
  const hour  = new Date().getHours();

  let data;
  try {
    const r = await fetch(`${RAIL_BOARD}?stationId=${sid}&date=${today}&hour=${hour}`,
      { headers: { Accept: "application/json" } });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    data = await r.json();
  } catch(e) {
    // CORS likely â€” show CLI fallback
    setMsg(out, `âŒ ×©×’×™××ª Railways API: ${e.message}<br>
      <small style="color:var(--muted)">×”-API ×¢×œ×•×œ ×œ×—×¡×•× ×‘×§×©×•×ª ××”×“×¤×“×¤×Ÿ (CORS).<br>
      ×”×¨×¥ ×‘×˜×¨××™× ×œ: <code style="color:var(--cyan)">python3 transit_query.py --train-station ${sid}</code></small>`, "err");
    return;
  }

  const trains = data?.result?.trains || data?.Data || data?.trains || [];
  if (!trains.length) {
    setMsg(out, `âš ï¸ ××™×Ÿ × ×¡×™×¢×•×ª ×‘×ª×—× ×ª ${sName} ×‘×©×¢×” ×”× ×•×›×—×™×ª.`, "warn");
    return;
  }

  let html = `<div class="summary">ğŸš† ${sName} â€” ${trains.length} × ×¡×™×¢×•×ª ×§×¨×•×‘×•×ª</div>`;
  for (const t of trains.slice(0, 15)) html += renderTrain(t);
  out.innerHTML = html;
}

function renderTrain(t) {
  const trainNum  = t.trainno  || t.TrainNumber  || "â€”";
  const schedDep  = t.departureTime       || t.DepartureTime       || "â€”";
  const actualDep = t.actualDepartureTime || t.ActualDepartureTime || "";
  const schedArr  = t.arrivalTime         || t.ArrivalTime         || "";
  const actualArr = t.actualArrivalTime   || t.ActualArrivalTime   || "";
  const platform  = t.platform  || t.Platform  || "?";
  const destId    = String(t.destStation    || t.DestinationStation || "");
  const origId    = String(t.orignStation   || t.OriginStation      || "");
  const cancelled = !!(t.isCancelled || t.IsCancelled);

  const destName  = TRAIN_STATIONS[destId]  || `×ª×—× ×” ${destId}`;
  const origName  = TRAIN_STATIONS[origId]  || `×ª×—× ×” ${origId}`;

  let delaySec = null;
  if (schedDep && schedDep !== "â€”" && actualDep && actualDep !== schedDep) {
    try {
      const toMin = s => { const c = String(s).replace(":",""); return +c.slice(0,2)*60 + +c.slice(2,4); };
      delaySec = (toMin(actualDep) - toMin(schedDep)) * 60;
    } catch {}
  }

  const delayed  = actualDep && actualDep !== schedDep;
  const delayedA = actualArr && actualArr !== schedArr;

  return `
  <div class="train-row">
    <div class="tn">ğŸš† ${trainNum}</div>
    <div class="route">${origName} â†’ ${destName}</div>
    <div class="platform">×¨×¦×™×£ ${platform}</div>
    <div class="times">
      ×™×¦×™××”: <span ${delayed?'style="text-decoration:line-through;color:var(--muted)"':''}>${schedDep}</span>
      ${delayed ? `<span style="color:var(--orange)"> â†’ ${actualDep}</span>` : ""}
      &nbsp;|&nbsp; ${statusBadge(delaySec, cancelled)}
      ${schedArr ? `&nbsp;|&nbsp; ×”×’×¢×”: <span>${schedArr}</span>${delayedA?`<span style="color:var(--orange)"> â†’ ${actualArr}</span>`:""}` : ""}
    </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Tab 4 â€” Track train by number  (track_train)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function trackTrain() {
  const trainNum = document.getElementById("train-input").value.trim();
  const out      = document.getElementById("results-train");
  if (!trainNum) { setMsg(out, "×”×›× ×¡ ××¡×¤×¨ ×¨×›×‘×ª", "warn"); return; }

  setLoading(out);

  const today = new Date().toISOString().slice(0,10);
  const hour  = new Date().getHours();
  // Same stations as transit_query.py check_stations list
  const checkStations = ["2300","2820","3400","3600","3100","5000","4600","700","2200","1220"];

  let found = null, foundStation = null;
  for (const sid of checkStations) {
    try {
      const r = await fetch(`${RAIL_BOARD}?stationId=${sid}&date=${today}&hour=${hour}`,
        { headers: { Accept: "application/json" } });
      if (!r.ok) continue;
      const data = await r.json();
      const trains = data?.result?.trains || data?.Data || data?.trains || [];
      for (const t of trains) {
        if (String(t.trainno || t.TrainNumber || "") === trainNum) {
          found = t; foundStation = sid; break;
        }
      }
    } catch {}
    if (found) break;
  }

  if (!found) {
    setMsg(out, `âš ï¸ ×¨×›×‘×ª ${trainNum} ×œ× × ××¦××”. ×™×™×ª×›×Ÿ ×©×˜×¨× ×™×¦××”, ×”×’×™×¢×” ×œ×™×¢×“, ××• ×©××¡×¤×¨×” ×©×’×•×™.`, "warn");
    return;
  }

  const sName = TRAIN_STATIONS[foundStation] || `×ª×—× ×” ${foundStation}`;
  out.innerHTML = `<div class="summary">âœ… ×¨×›×‘×ª ${trainNum} × ××¦××” ×‘×ª×—× ×ª ${sName}</div>` + renderTrain(found);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Tab 5 â€” Service alerts
//  GTFS-RT protobuf can't be decoded natively in browser.
//  Show CLI instructions + API status check.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAlerts() {
  const out = document.getElementById("results-alerts");
  setLoading(out);

  let apiStatus = "";
  try {
    const r = await fetch(`${OPEN_BUS_BASE}/siri_vehicle_locations/list?limit=1&order_by=id desc`);
    if (r.ok) {
      const data = await r.json();
      if (data.length) {
        const age = Math.round((Date.now() - new Date(data[0].recorded_at_time).getTime()) / 60000);
        apiStatus = `<div class="msg-box ok">âœ… Open Bus Stride API ×¤×¢×™×œ â€” × ×ª×•×Ÿ ××—×¨×•×Ÿ ××œ×¤× ×™ ${age} ×“×§×•×ª</div>`;
      }
    }
  } catch {}

  out.innerHTML = `
    ${apiStatus}
    <div class="alert-card">
      <div class="a-title">ğŸ”” ×”×ª×¨××•×ª ×©×™×¨×•×ª â€” GTFS-RT ServiceAlerts</div>
      <div class="a-effect">GTFS-RT ×”×•× ×¤×•×¨××˜ ×‘×™× ××¨×™ (protobuf) ×©××™× ×• × ×™×ª×Ÿ ×œ×¤×¢× ×•×— ×™×©×™×¨×•×ª ×‘×“×¤×“×¤×Ÿ.</div>
      <div style="font-size:.82rem;color:var(--muted);margin-top:8px;line-height:1.8">
        ×œ×”×¦×’×ª ×”×ª×¨××•×ª ×¤×¢×™×œ×•×ª ×”×¨×¥ ×‘×˜×¨××™× ×œ:<br>
        <code style="color:var(--cyan)">python3 transit_query.py --alerts</code>
      </div>
    </div>
    <div class="alert-card" style="border-right-color:var(--accent)">
      <div class="a-title">ğŸ“‹ ×›×œ×™ ×©×•×¨×ª ×”×¤×§×•×“×” â€” transit_query.py</div>
      <div style="font-size:.82rem;color:var(--muted);margin-top:6px;line-height:2">
        <code style="color:var(--cyan)">python3 transit_query.py</code> â€” ×ª×¤×¨×™×˜ ××™× ×˜×¨××§×˜×™×‘×™<br>
        <code style="color:var(--cyan)">python3 transit_query.py --address "×“×™×–× ×’×•×£ 50, ×ª\"×"</code><br>
        <code style="color:var(--cyan)">python3 transit_query.py --line 89</code><br>
        <code style="color:var(--cyan)">python3 transit_query.py --train-station 2300</code><br>
        <code style="color:var(--cyan)">python3 transit_query.py --track-train 145</code><br>
        <code style="color:var(--cyan)">python3 transit_query.py --alerts</code>
      </div>
    </div>`;
}

// â”€â”€ Enter key shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("addr-input").addEventListener("keydown",    e=>{ if(e.key==="Enter") searchNearAddress(); });
document.getElementById("line-input").addEventListener("keydown",    e=>{ if(e.key==="Enter") searchLine(); });
document.getElementById("station-input").addEventListener("keydown", e=>{ if(e.key==="Enter") searchStation(); });
document.getElementById("train-input").addEventListener("keydown",   e=>{ if(e.key==="Enter") trackTrain(); });

// Auto-load alerts when switching to that tab
document.querySelector('[data-tab="tab-alerts"]').addEventListener("click", () => {
  if (!document.getElementById("results-alerts").innerHTML) loadAlerts();
});
</script>
</body>
</html>